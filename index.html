<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>✨致谢伊菲 - 璀璨星河✨</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
    body { margin: 0; overflow: hidden; background: #020205; touch-action: none; }
    canvas { display: block; background: #000; }
    .hint {
        position: absolute; bottom: 8%; width: 100%; text-align: center;
        color: rgba(255, 255, 255, 0.4); font-family: sans-serif; font-size: 14px;
        pointer-events: none; letter-spacing: 2px; z-index: 10;
    }
</style>
</head>
<body>
<div class="hint">点击屏幕 · 开启专属烟花</div>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { alpha: false });

let cw, ch;
let fireworks = [];
let particles = [];
let textPixels = [];

const CONFIG = {
    text: "谢伊菲\n新年快乐",
    particleBaseCount: 200,   
    textPixelGap: 8,          
    gravity: 0.05,
    friction: 0.95
};

function init() {
    cw = canvas.width = window.innerWidth;
    ch = canvas.height = window.innerHeight;
    prepareText();
}

function prepareText() {
    const tCanvas = document.createElement('canvas');
    const tCtx = tCanvas.getContext('2d');
    tCanvas.width = cw;
    tCanvas.height = ch;
    
    tCtx.fillStyle = "#fff";
    tCtx.font = `bold ${cw * 0.15}px sans-serif`;
    tCtx.textAlign = "center";
    tCtx.textBaseline = "middle";
    
    const lines = CONFIG.text.split('\n');
    const lineHeight = cw * 0.18;
    const startY = (ch - (lines.length - 1) * lineHeight) / 2;
    lines.forEach((line, i) => {
        tCtx.fillText(line, cw/2, startY + i * lineHeight);
    });

    const data = tCtx.getImageData(0, 0, cw, ch).data;
    textPixels = [];
    for (let y = 0; y < ch; y += CONFIG.textPixelGap) {
        for (let x = 0; x < cw; x += CONFIG.textPixelGap) {
            if (data[((y * cw + x) * 4) + 3] > 128) {
                textPixels.push({x, y});
            }
        }
    }
    textPixels.sort(() => Math.random() - 0.5);
}

class Particle {
    constructor(x, y, hue, targetIdx = null) {
        this.x = x; this.y = y;
        this.hue = hue;
        this.alpha = 1;
        this.target = targetIdx !== null ? textPixels[targetIdx] : null;
        
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 8 + 2;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        
        this.decay = this.target ? 0.008 : 0.02;
        this.size = this.target ? 2.5 : 1.5;
    }

    update() {
        if (this.target) {
            const dx = this.target.x - this.x;
            const dy = this.target.y - this.y;
            this.vx += dx * 0.004;
            this.vy += dy * 0.004;
            this.vx *= 0.9;
            this.vy *= 0.9;
        } else {
            this.vx *= CONFIG.friction;
            this.vy *= CONFIG.friction;
            this.vy += CONFIG.gravity;
        }
        this.x += this.vx;
        this.y += this.vy;
        this.alpha -= this.decay;
    }

    draw() {
        ctx.fillStyle = `hsla(${this.hue}, 100%, 65%, ${this.alpha})`;
        ctx.fillRect(this.x, this.y, this.size, this.size);
    }
}

class Firework {
    constructor(sx, sy, tx, ty) {
        this.x = sx; this.y = sy;
        this.tx = tx; this.ty = ty;
        this.speed = 10;
        this.hue = Math.random() * 360;
        this.done = false;
    }
    update() {
        const dx = this.tx - this.x;
        const dy = this.ty - this.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 10) {
            this.explode();
            this.done = true;
        } else {
            this.x += (dx/dist) * this.speed;
            this.y += (dy/dist) * this.speed;
        }
    }
    draw() {
        ctx.fillStyle = `hsla(${this.hue}, 100%, 70%, 1)`;
        ctx.fillRect(this.x, this.y, 3, 3);
    }
    explode() {
        let textPixelIdx = 0;
        for (let i = 0; i < CONFIG.particleBaseCount; i++) {
            let targetIdx = null;
            if (i % 2 === 0 && textPixels.length > 0) {
                targetIdx = Math.floor(Math.random() * textPixels.length);
            }
            const hue = targetIdx ? 45 : this.hue + (Math.random()*40-20);
            particles.push(new Particle(this.x, this.y, hue, targetIdx));
        }
    }
}

function loop() {
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = 'rgba(2, 2, 5, 0.2)';
    ctx.fillRect(0, 0, cw, ch);
    ctx.globalCompositeOperation = 'lighter';

    let i = fireworks.length;
    while(i--) {
        fireworks[i].update();
        fireworks[i].draw();
        if (fireworks[i].done) fireworks.splice(i, 1);
    }

    let j = particles.length;
    while(j--) {
        particles[j].update();
        particles[j].draw();
        if (particles[j].alpha <= 0) particles.splice(j, 1);
    }
    requestAnimationFrame(loop);
}

// 统一交互函数
function launch(clientX, clientY) {
    fireworks.push(new Firework(cw/2, ch, clientX, clientY));
}

// 监听点击和触摸
canvas.addEventListener('mousedown', e => launch(e.clientX, e.clientY));
canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    launch(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });

window.addEventListener('resize', init);

// 初始化并启动
init();
loop();

// 自动演示：如果用户不点，每3秒自动放一个
setInterval(() => {
    if (fireworks.length === 0 && particles.length < 50) {
        launch(Math.random() * cw, ch * 0.3);
    }
}, 3000);

</script>
</body>
</html>
